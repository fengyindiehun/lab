#include "conhash.h"
#include "ae.h"
#include "net.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#define REPLICAS 20
#define MAXLINE 1024

static cluster *cl;

void sendServerIp(int listenfd,void *argv,int mask)
{
	int clientfd, n;
	char BUFF[MAXLINE];
	char RQFILE[MAXLINE];
	char *ptr;

	socklen_t clientaddr_len;
	struct sockaddr_storage clientaddr;
	
	clientaddr_len = sizeof(clientaddr);
	clientfd = accept(listenfd,(SA *)&clientaddr,&clientaddr_len);
	
	if ((n = read(clientfd,BUFF,MAXLINE)) > 0) {
		ptr = strstr(BUFF,"GET ");
		memcpy(RQFILE,ptr + 4,strstr(ptr,"\r\n") - ptr - 4);
		
		ptr = clusterGetServer(cl,RQFILE);
		write(clientfd,ptr,strlen(ptr));
	}
	
	close(clientfd);
}


int main(int argc, char **argv)
{
	int listenfd, connfd;
	EL *el;

	socklen_t addrlen;
	char BUFF[MAXLINE];
	struct sockaddr_storage cliaddr;
	
	if (argc == 2)
		listenfd = tcpListen(NULL,argv[1],&addrlen);
	else if (argc == 3)
		listenfd = tcpListen(argv[1],argv[2],&addrlen);
	else
		err_quit("usage: [HOST] <PORT>\n");
	
	if ((el = el_open()) == NULL)
		err_quit("server error for creating epoll.\n");
	if ((cl = clusterCreate()) == NULL)
		err_quit("server error for creating cluster.\n");
	
	clusterAddServer(cl,"8.8.8.8",REPLICAS);
	clusterAddServer(cl,"8.8.4.4",REPLICAS);
	
	el_addFileEvent(el,listenfd,AE_READABLE,,NULL);
	
	el_start(el,AE_BLOCK);
	
	el_close(el);
}
